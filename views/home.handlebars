<style>
.genre-filter{
    margin: 5px;
    padding: 5px;
    width: 400%;
}

.genre-filter li{
    width: 25%;
    padding: 5px;
    float: left;
}

.genre-filter label{
    padding: 5px;
}


/*input:checked{
    background-color: black;
    border: 20px solid black;
}*/

@media (max-width: 769px){
    .genre-filter{
        width: 300%;
    }
    .genre-filter li{
        width: 33.33%;
    }
}

@media (max-width: 424px){
    .genre-filter{
        width: 200%;
    }

    .genre-filter li{
        width: 50%;
    }
}
</style>

<div class="above-cards">
    <div class="title-container">
        <h1>Currently Airing</h1>
        <h3>Sorted by score</h3>
    </div>

    <div class="loading-error alert alert-warning" role="alert">
    </div>
    <!--
    = * = * =
    Buttons for all the filtering
    = * = * =
-->
<div class="col button-container">
    <div class="row">
        <div class="btn-group" role="group">
            <button class="btn btn-secondary" id="current-year">Search</button>
            <input type="text" placeholder="Year "id="year-input" style="width: 75px;" class="form-control" aria-describedby="current-year">
            <button id="season-drop" data-season="Spring" type="button" class="btn btn-lg btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Spring
            </button>
            <div class="dropdown-menu season-buttons" aria-labelledby="season-drop">
                <button class="dropdown-item" data-id="Spring">Spring</button>
                <button class="dropdown-item" data-id="Summer">Summer</button>
                <button class="dropdown-item" data-id="Fall">Fall</button>
                <button class="dropdown-item" data-id="Winter">Winter</button>
            </div>

        </div>
    </div>
    <div class="row">
        <button type="button" class="btn btn-secondary btn-lg" id="airing">Show Airing</button>
        <button style="width: 150px;" id="sort-drop" type="button" class="btn btn-lg btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Sort by:
        </button>
        <div class="dropdown-menu main-filters">
            <button class="dropdown-item" data-id="score" id="sort-score">&#9660; Score</button>
            <button class="dropdown-item" data-id="popularity" id="sort-pop">&#9660; Popularity</button>
        </div>
    </div>
    <div class="row">
        <!-- Time for the genres...! -->
        <div class="dropdown tags">
            <button type="button" class="btn btn-lg btn-secondary dropdown-toggle" data-toggle="dropdown">Genre Select<span class="caret"></span></button>
            <ul class="dropdown-menu genre-filter">
                <!-- <div class="tags"> -->
                <li><label><input type="checkbox" rel="action" />Action</label></li>
                <li><label><input type="checkbox" rel="adventure" />Adventure</label></li>
                <li><label><input type="checkbox" rel="comedy" />Comedy</label></li>
                <li><label><input type="checkbox" rel="drama" />Drama</label></li>
                <li><label><input type="checkbox" rel="ecchi" />Ecchi</label></li>
                <li><label><input type="checkbox" rel="fantasy" />Fantasy</label></li>
                <li><label><input type="checkbox" rel="mahoushoujo" />Mahou Shoujo</label></li>
                <li><label><input type="checkbox" rel="mecha" />Mecha</label></li>
                <li><label><input type="checkbox" rel="music" />Music</label></li>
                <li><label><input type="checkbox" rel="mystery" />Mystery</label></li>
                <li><label><input type="checkbox" rel="psychological" />Psychological</label></li>
                <li><label><input type="checkbox" rel="romance" />Romance</label></li>
                <li><label><input type="checkbox" rel="sci-fi" />Sci-fi</label></li>
                <li><label><input type="checkbox" rel="sliceoflife" />Slice of Life</label></li>
                <li><label><input type="checkbox" rel="sports" />Sports</label></li>
                <li><label><input type="checkbox" rel="supernatural" />Supernatural</label></li>
                <li><label><input type="checkbox" rel="thriller" />Thriller</label></li>
                <li><button class="clear-all">Clear All</button></li>
                <!-- </div> -->
            </ul>
        </div>
    </div>

</div>
</div>
<span class="loading-modal">
    <img src="../../images/TamamoBall4.gif"><p>LOADING</p>
</span>
<span class="loading"><img src="../../images/TamamoBall4.gif"><br>LOADING</span>
<!--
= * = * =
Actual content below
= * = * =
-->
<div class="d-flex flex-row flex-wrap justify-content-start" id="home-container">
    {{> home-search}}
</div>


<div class="mymodal">
    <div class="modalcontent">
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>
var airing = true;
var year;
var season = "Spring"


$('body').on('click', '.dropdown-menu', function (e) {
    e.stopPropagation();
});

// Modals
$('body').on('click', '.card', function(e) {
    let url = "/" + $(this).data('id')
    $('.loading-modal').show()
    $.ajax({
        url: "/modal"+url,
        type: 'GET'
    }).done((data) => {
        // Need this to remove scrolling
        $("body").addClass("modal-open");
        $('.loading-modal').hide()

        // Data -> modal
        $('.modalcontent').html(data)
        $(".mymodal").fadeIn("400")
    }).fail(() => {
        console.log("Failed")
    });
})

// Modal remove
$('body').on('click', '.closemodal', function(e) {
    $("body").removeClass("modal-open")
    $('.mymodal').hide()
    $('.modalcontent').html("")
})

// === === === === === ===
// === === SORTING === ===
// === === === === === ===

// Sort by score or popularity
$('body').on('click', '.main-filters > *', function(e) {
    let sorting = $(this).data('id')
    $('.loading').show()
    let genres = genrelist();

    if(airing == true){
        $.ajax({
            url: `/home-sort/${sorting}/${genres}`,
            type: 'GET'
        }).done((data) => {
            showdata(data)
            $('.title-container').children("h3").html(`Sorted by ${sorting}`)
            $('#sort-drop').html(`&#9660; ${capitalize(sorting)}`)
        }).fail(() => {
            console.log("Failed")
        });
    }
    else{
        $.ajax({
            url: `/home-sort/${sorting}-date/${season}/${year}/${genres}`,
            type: 'GET'
        }).done((data) => {
            showdata(data)
            $('.title-container').children("h3").html(`Sorted by ${sorting}`)
            $('#sort-drop').html(`&#9660; ${capitalize(sorting)}`)
        }).fail(() => {
            console.log("Failed")
        });
    }

})

// === === === === === ===
// === ===  DATING === ===
// === === === === === ===
// Back to airing stuff!

// All airing; default to score without dates
$('body').on('click', '#airing', function(e) {
    $('.loading').show()
    airing = true
    let genres = genrelist();

    $.ajax({
        url: `/home-sort/score/${genres}`,
        type: 'GET'
    }).done((data) => {
        showdata(data)
        $('.title-container').children("h1").html("Currently Airing")
        $('.title-container').children("h3").html("Sorted by score")
        $('#sort-drop').html("&#9660; Score")
    }).fail(() => {
        console.log("Failed")
    });
})

// Changing the season up; defaults to score
$('body').on('click', '.season-buttons > .dropdown-item', function(e) {
    season = $(this).data('id')
    year = $('#year-input').val()
    // Change the box
    $('#season-drop').attr('data-season', season)
    if(!jQuery.isNumeric(year) && !year){
        console.log("Not quite!")
        $('.loading-error').show()
        $('.loading-error').html("Please input a year for the filter!")
        return setTimeout(function(){$('.loading-error').fadeOut(400); return}, 2000);
    }
    $('.loading').show()

    let genres = genrelist()
    $.ajax({
        url: `/home-sort/score-date/${season}/${year}/${genres}`,
        type: 'GET'
    }).done((data) => {
        if(!data){
            console.log(data)
            $('#home-container').html("Nothing here!")
        }
        airing = false
        showdata(data)
        $('.title-container').children("h1").html(`${season}, ${year.substring(0,4)}`)
        $('.title-container').children("h3").html("Sorted by Score")
        $('#sort-drop').html("&#9660; Score")
        $('#season-drop').html(season)
    }).fail(() => {
        console.log("Failed")
    });
})

// When you click on year
$('body').on('click', '#current-year', function(e) {
    year = $('#year-input').val()
    let genres = genrelist()

    if(!jQuery.isNumeric(year) && !year){
        console.log("Not quite!")
        $('.loading-error').show()
        $('.loading-error').html("Please input a year for the filter!")
        $('#season-drop').attr('data-season', season)
        return setTimeout(function(){$('.loading-error').fadeOut(400); return}, 2000);
    }

    $('.loading').show()

    $.ajax({
        url: `/home-sort/score-date/${season}/${year}/${genres}`,
        type: 'GET'
    }).done((data) => {
        if(!data){
            console.log(data)
            $('#home-container').html("<h1>Nothing here!</h1>")
            $('.loading').hide()
        }
        else{
            showdata(data)
        }
        airing = false
        $('.title-container').children("h1").html(`${season}, ${year.substring(0,4)}`)
        $('.title-container').children("h3").html("Sorted by Score")
        $('#sort-drop').html("&#9660; Score")
    }).fail(() => {
        console.log("Failed")
    });
})

// For clicking on prequels
$('body').on('click', '#prequel', function(e) {
    let url = "/" + $(this).data('id')
    $('.loading-modal').show()
    $.ajax({
        url: "/modal"+url,
        type: 'GET'
    }).done((data) => {
        $('.loading-modal').hide()
        $('.modalcontent').html(data)
        $('.modalcontent').fadeIn(400)

    }).fail(() => {
        console.log("Failed")
    });
})

// For clicking on sequels
$('body').on('click', '#sequel', function(e) {
    let url = "/" + $(this).data('id')
    $('.loading-modal').show()

    $.ajax({
        url: "/modal"+url,
        type: 'GET'
    }).done((data) => {
        $('.loading-modal').hide()
        $('.modalcontent').html(data)
        $('.modalcontent').fadeIn(400)
    }).fail(() => {
        console.log("Failed")
    });
})

// === === === === === ===
// === === FILTERS === ===
// === === === === === ===

$("body").on('click', '.clear-all', (e) => {
    $('input[type="checkbox"]:checked').prop('checked',false);
})

function capitalize(word){
    return word[0].toUpperCase() + word.slice(1)
}

function genrelist(){
    let genrelist = "genres?q="
    $('div.tags').find('input:checked').each(function () {
        genrelist += ($(this).attr('rel') + ",")
    });
    return genrelist.slice(0, -1)

}
function showdata(data){
    $('#home-container').fadeOut(200)
    $('.loading').hide()
    $('#home-container').html(data)
    $('#home-container').fadeIn(200)
}

</script>
